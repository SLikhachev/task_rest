# Общие вопрсы о приложении

В файле собраны вопросы общего характера о работе приложения

## База данных

### Резервные копии БД

### Миграции БД

### Как создать таблицы талонов и пму на следующий год

Поскольку __ТАЛОНЫ__ и связанные с ними __ПМУ__ разбиты на таблицы по годам, то
при наступлении очередного года, необходимо клонировать (создать пустые) таблицы,
в которые будут заноситься данные в слудующем году.

Для этого в БД есть процедура названная:

    function CLONE_TALONZ_TABLE(rls boolean) returns void as

Новые таблицы нужно создавать в текущем (уходящем) году, например в
декабре уходящего года, так как имена создаваемых таблиц включают
последние две цифры года, и последняя цифра на еденицу больше чем последняя
цифра текущего года.

Параметр __rls__ логического типа и указывает процедуре, что таблицы будут
создаваться в схеме __webz__, и после создания таблиц будут установлены правила
ROW LEVEL SECURITY

В настоящее время создавать таблицы можно только вручную, например в клиенте
__psql__.

#### Использование клиента psql

Запускаем клиента командой

```sh
$> psql -U postgres -h 127.0.0.1 -d hokuto
```

Здесь мы авторизуемся от имени роли _postgres_ (это плохой вариант,
нужно создать специальную роль для доступа к кластеру БД). Сервер должен
быть сконфигурирован так, чтобы слушать стандартный порт _5432_ на локальном
адресе 127.0.0.1, имя базы данных __hokuto__.

После входа убедимся, что процедура клонирования есть в базе

    hokuto=# \x auto
    hokuto=# \dfn clone_*

Результат вызова команды должен иметь вид:

| Схема  |        Имя        | Тип данных результата | Типы данных аргументов | Тип |
| :-----: | :------------: | :------------------: | :--------------------: | :--: |
| public   | clone_talonz_table |  void                   |   rls boolean                 | функ.|
(1 строка)

Создаем таблицы:

    select * from clone_talonz_table(false);

вывод команды:

    ЗАМЕЧАНИЕ:  Talonz tables = talonz_clin_21 - talonz_clin_22
    ЗАМЕЧАНИЕ:  Para tables = para_clin_21 - para_clin_22
    clone_talonz_table
    --------------------
    (1 строка)

Смотрим, что таблицы действительно созданы

    hokuto=# \dt talonz_*
    hokuto=# \d talonz_clin_22

В примерах выше предполагается что команды выполнялись в конце 2021 года.

### Как обновить справочник тарифов на ПМУ по взиморасчнтам

Ежегодно ТФОМС обновляет тарифи на услуги по ОМС по взаиморасчнтам.
Соответвенно возникает проблема обновления тарифов в базе данных.

#### Обновление тарифов в тестовом режиме

Пока не реализовано иное, будем обновлять тарифы в тестовом режиме:

1) Добываем с сайта фонда файл с тарифами (обчно .xlsx) и трансформируем его
в файл csv
    > типичная строчка файла<br>
    > `A06.03.062;Компьютерная томография кости;2230.73`<br>
    > Код услуги;Наименование;Цена

2) Внимательно смортим в файл, строки не долны содержить неожиданных переводев каретк,
или лишних кавычек, или непечатных символов

3) Укладываем файл tarifs.csv тарифы в папку (в файле должны быть ВСЕ импортируемые тарифы)

    `~/venv/task_rest/test/data/tarif/tarifs.csv`

4) Переходим в виртуальное окружение, и активирум его и переходм в папку
с приложением

```sh
$> cd venv
$> vact
$> cd task_rest/webapp
```

5) В папке `./pytest/pytest_sprav.ini` расположен __INI__ файл для тестрования
модуля справочников, конретно там указано имя файла с тарифами

    `PMU_CSV_FILE=tarifs.csv`

6) Запускаем тест, который собственно и обноввит все тарифы взаиморасчетов

```sh
$> pytest -c pytest/pystes_sprav.ini
```

В итоге тарифы должны обновится.
